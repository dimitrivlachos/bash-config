# bashrc_core

export BASH_CONFIG_VERSION="2.0.0"

# export BASH_CONFIG_DEBUG="${BASH_CONFIG_DEBUG:-true}"

# export BASH_CONFIG_DIR="${BASH_CONFIG_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"

# Resolve the real path of this script (even if symlinked)
__realpath() {
  local path="$1"
  while [ -L "$path" ]; do
    path="$(readlink "$path")"
    [[ "$path" != /* ]] && path="$(dirname "$1")/$path"
  done
  cd "$(dirname "$path")" && pwd
}

export BASH_CONFIG_DIR="${BASH_CONFIG_DIR:-$(__realpath "${BASH_SOURCE[0]}")}"

# Validate configuration directory
if [[ ! -d "$BASH_CONFIG_DIR" ]]; then
  echo "[ERROR] BASH_CONFIG_DIR not found: $BASH_CONFIG_DIR" >&2
  return 1 2>/dev/null || exit 1
fi

# Load shared components with error checking
bc_source_if_exists() {
  local file="$1"
  local description="${2:-$file}"
  if [[ -f "$file" ]]; then
    source "$file"
  else
    echo "[WARN] $description not found: $file" >&2
  fi
}

bc_source_if_exists "$BASH_CONFIG_DIR/secrets/bash_secrets.sh" "Secrets file"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_aliases" "Aliases"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_exports" "Exports"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_prompt" "Prompt configuration"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_tools" "Tools and functions"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_ssh" "SSH management"
bc_source_if_exists "$BASH_CONFIG_DIR/bash_history" "History management"

# Load specialisation
if [[ -n "${BASH_SPECIALISATION:-}" ]]; then
  spec_file="$BASH_CONFIG_DIR/specialisations/bashrc_$BASH_SPECIALISATION"
  case "$BASH_SPECIALISATION" in
    frostpaw|diamond|asteria)
      if [[ -f "$spec_file" ]]; then
        source "$spec_file"
        # echo "[INFO] Loaded specialisation: $BASH_SPECIALISATION" >&2
      else
        echo "[ERROR] Specialisation file not found: $spec_file" >&2
      fi
      ;;
    *)
      echo "[ERROR] Unknown specialisation: $BASH_SPECIALISATION" >&2
      echo "[INFO] Available specialisations: frostpaw, diamond, asteria" >&2
      ;;
  esac
fi

# Initial prompt
set_prompt
PROMPT_COMMAND=set_prompt

# Show fastfetch on login
# [[ $- == *i* ]] â†’ only interactive shells
if [[ $- == *i* ]]; then
  bc_ff
  
  # Check for updates (but only once per day to avoid slowdown)
  # Only check if we have a real terminal (not in scripts/pipes/ssh commands)
  if [[ -t 0 ]]; then
    update_check_file="$BASH_CONFIG_DIR/.last_update_check"
    current_date=$(date +%Y%m%d)
    
    if [[ ! -f "$update_check_file" ]] || [[ "$(cat "$update_check_file" 2>/dev/null)" != "$current_date" ]]; then
      # Check for updates synchronously (once per day, so acceptable delay)
      bc_check_updates silent
      check_result=$?
      if [[ $check_result -eq 2 ]]; then
        bc_check_updates notify
      fi
      echo "$current_date" > "$update_check_file"
    fi
  fi
fi